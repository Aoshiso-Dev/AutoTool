<UserControl x:Class="MacroPanels.View.EditPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converter="clr-namespace:MacroPanels.View.Converter"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">

    <UserControl.Resources>
        <converter:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converter:BoolToVisibilityMultiConverter x:Key="BoolToVisibilityMultiConverter"/>
        <converter:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converter:KeyToStringConverter x:Key="KeyToStringConverter"/>
        
        <!-- Windows 11 設定画面風カードスタイル -->
        <Style x:Key="SettingCard" TargetType="Border">
            <Setter Property="Background" Value="{ui:ThemeResource ControlFillColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="16,12"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
        </Style>
        
        <Style x:Key="SettingLabel" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        
        <Style x:Key="SettingDescription" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>
    </UserControl.Resources>

    <Grid IsEnabled="{Binding IsRunning, Converter={StaticResource InverseBooleanConverter}}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="400"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="Auto" MinWidth="200" MaxWidth="400"/>
        </Grid.ColumnDefinitions>

        <!-- メイン設定エリア -->
        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <StackPanel Margin="4">
                
                <!-- リストが空の場合 -->
                <StackPanel Visibility="{Binding IsListEmpty, Converter={StaticResource BoolToVisibilityConverter}}" 
                            Margin="0,60" HorizontalAlignment="Center">
                    <ui:SymbolIcon Symbol="DocumentAdd24" FontSize="48" 
                                   Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"/>
                    <TextBlock Text="リストにコマンドを追加してください" 
                               Style="{StaticResource SettingLabel}"
                               HorizontalAlignment="Center" Margin="0,16,0,8"/>
                    <TextBlock Text="上部の「追加」ボタンでコマンドを追加できます" 
                               Style="{StaticResource SettingDescription}"
                               HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- 未選択の場合 -->
                <StackPanel Visibility="{Binding IsListNotEmptyButNoSelection, Converter={StaticResource BoolToVisibilityConverter}}" 
                            Margin="0,60" HorizontalAlignment="Center">
                    <ui:SymbolIcon Symbol="CursorClick24" FontSize="48" 
                                   Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"/>
                    <TextBlock Text="コマンドを選択してください" 
                               Style="{StaticResource SettingLabel}"
                               HorizontalAlignment="Center" Margin="0,16,0,8"/>
                    <TextBlock Text="リストから編集するコマンドを選択すると設定が表示されます" 
                               Style="{StaticResource SettingDescription}"
                               HorizontalAlignment="Center"/>
                </StackPanel>

                <!-- 設定項目 -->
                <StackPanel Visibility="{Binding IsNotNullItem, Converter={StaticResource BoolToVisibilityConverter}}">
                    
                    <!-- コマンド種類 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="コマンド種類" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="実行するコマンドの種類を選択" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <ComboBox Grid.Column="1" 
                                      ItemsSource="{Binding ItemTypes}" 
                                      SelectedItem="{Binding SelectedItemTypeObj}" 
                                      DisplayMemberPath="DisplayName"
                                      MinWidth="200"/>
                        </Grid>
                    </Border>

                    <!-- 対象ウィンドウ -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsWaitImageItem"/>
                                <Binding Path="IsClickImageItem"/>
                                <Binding Path="IsClickImageAIItem"/>
                                <Binding Path="IsClickItem"/>
                                <Binding Path="IsHotkeyItem"/>
                                <Binding Path="IsIfImageExistItem"/>
                                <Binding Path="IsIfImageNotExistItem"/>
                                <Binding Path="IsIfImageExistAIItem"/>
                                <Binding Path="IsIfImageNotExistAIItem"/>
                                <Binding Path="IsSetVariableAIItem"/>
                                <Binding Path="IsScreenshotItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <StackPanel>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="対象ウィンドウ" Style="{StaticResource SettingLabel}"/>
                                    <TextBlock Text="操作対象のウィンドウを指定（空欄で全画面対象）" Style="{StaticResource SettingDescription}"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <ui:Button Content="取得" Icon="{ui:SymbolIcon WindowNew20}" 
                                               Command="{Binding GetWindowInfoCommand}" Margin="0,0,4,0"/>
                                    <ui:Button Icon="{ui:SymbolIcon Dismiss24}" ToolTip="クリア"
                                               Command="{Binding ClearWindowInfoCommand}" Appearance="Secondary"/>
                                </StackPanel>
                            </Grid>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="100"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="タイトル:" VerticalAlignment="Center" 
                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,8,4"/>
                                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding WindowTitleText, Mode=OneWay}" 
                                         IsReadOnly="True" Margin="0,0,0,4"/>
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="クラス名:" VerticalAlignment="Center"
                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,8,0"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding WindowClassNameText, Mode=OneWay}" 
                                         IsReadOnly="True"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- 画像パス -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsWaitImageItem"/>
                                <Binding Path="IsClickImageItem"/>
                                <Binding Path="IsIfImageExistItem"/>
                                <Binding Path="IsIfImageNotExistItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="検索画像" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="{Binding ImagePath, TargetNullValue='画像が選択されていません'}" 
                                           Style="{StaticResource SettingDescription}" 
                                           TextTrimming="CharacterEllipsis" MaxWidth="300"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <ui:Button Content="参照" Icon="{ui:SymbolIcon FolderOpen24}" 
                                           Command="{Binding BrowseCommand}" Margin="0,0,4,0"/>
                                <ui:Button Content="キャプチャ" Icon="{ui:SymbolIcon Screenshot24}" 
                                           Command="{Binding CaptureCommand}" Appearance="Primary"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- しきい値 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsWaitImageItem"/>
                                <Binding Path="IsClickImageItem"/>
                                <Binding Path="IsIfImageExistItem"/>
                                <Binding Path="IsIfImageNotExistItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="200"/>
                                <ColumnDefinition Width="60"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="一致しきい値" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="画像一致度の最小値（0.01〜1.00）" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <Slider Grid.Column="1" Value="{Binding Threshold}" 
                                    Minimum="0.01" Maximum="1.00" SmallChange="0.01" LargeChange="0.1"
                                    TickFrequency="0.01" IsSnapToTickEnabled="True" VerticalAlignment="Center"/>
                            <TextBlock Grid.Column="2" Text="{Binding Threshold, StringFormat={}{0:F2}}" 
                                       VerticalAlignment="Center" HorizontalAlignment="Right"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                        </Grid>
                    </Border>

                    <!-- 強調検索色 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsWaitImageItem"/>
                                <Binding Path="IsClickImageItem"/>
                                <Binding Path="IsIfImageExistItem"/>
                                <Binding Path="IsIfImageNotExistItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="強調検索色" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="{Binding SearchColorText}" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Border Width="32" Height="32" CornerRadius="4" Margin="0,0,8,0"
                                        Background="{Binding SearchColorBrush}"
                                        BorderBrush="{ui:ThemeResource ControlStrokeColorDefaultBrush}"
                                        BorderThickness="1"/>
                                <ui:Button Icon="{ui:SymbolIcon Eyedropper24}" ToolTip="色を取得"
                                           Command="{Binding PickSearchColorCommand}" Margin="0,0,4,0"/>
                                <ui:Button Icon="{ui:SymbolIcon Dismiss24}" ToolTip="クリア"
                                           Command="{Binding ClearSearchColorCommand}" Appearance="Secondary"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- タイムアウト・間隔 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsWaitImageItem"/>
                                <Binding Path="IsClickImageItem"/>
                                <Binding Path="IsClickImageAIItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="タイムアウト" Style="{StaticResource SettingLabel}"/>
                                <ui:NumberBox Value="{Binding Timeout}" Minimum="0" SpinButtonPlacementMode="Compact"/>
                                <TextBlock Text="ミリ秒" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="検索間隔" Style="{StaticResource SettingLabel}"/>
                                <ui:NumberBox Value="{Binding Interval}" Minimum="0" SpinButtonPlacementMode="Compact"/>
                                <TextBlock Text="ミリ秒" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- マウスボタン -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsClickImageItem"/>
                                <Binding Path="IsClickImageAIItem"/>
                                <Binding Path="IsClickItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="マウスボタン" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="クリックに使用するボタン" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <ComboBox Grid.Column="1" ItemsSource="{Binding MouseButtons}" 
                                      SelectedItem="{Binding SelectedMouseButton}" MinWidth="120"/>
                        </Grid>
                    </Border>

                    <!-- クリック座標 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsClickItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="クリック座標" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Style="{StaticResource SettingDescription}">
                                    <Run Text="X: "/><Run Text="{Binding X}"/>
                                    <Run Text="  Y: "/><Run Text="{Binding Y}"/>
                                </TextBlock>
                            </StackPanel>
                            <ui:Button Grid.Column="1" Content="座標を取得" Icon="{ui:SymbolIcon Location24}"
                                       Command="{Binding PickPointCommand}" Appearance="Primary"/>
                        </Grid>
                    </Border>

                    <!-- ホットキー -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsHotkeyItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <StackPanel>
                            <TextBlock Text="ホットキー設定" Style="{StaticResource SettingLabel}" Margin="0,0,0,8"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <CheckBox Content="Ctrl" IsChecked="{Binding Ctrl}" Margin="0,0,16,0"/>
                                <CheckBox Content="Shift" IsChecked="{Binding Shift}" Margin="0,0,16,0"/>
                                <CheckBox Content="Alt" IsChecked="{Binding Alt}"/>
                            </StackPanel>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="60"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="キー:" VerticalAlignment="Center"
                                           Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                <TextBox Grid.Column="1" 
                                         Text="{Binding Key, Converter={StaticResource KeyToStringConverter}}"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- 待機時間 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsWaitItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="150"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="待機時間" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="指定した時間待機します" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1">
                                <ui:NumberBox Value="{Binding Wait}" Minimum="0" SpinButtonPlacementMode="Compact"/>
                                <TextBlock Text="ミリ秒" Style="{StaticResource SettingDescription}" HorizontalAlignment="Right"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- ループ回数 -->
                    <Border Style="{StaticResource SettingCard}">
                        <Border.Visibility>
                            <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                                <Binding Path="IsLoopItem"/>
                            </MultiBinding>
                        </Border.Visibility>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="150"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="ループ回数" Style="{StaticResource SettingLabel}"/>
                                <TextBlock Text="0で無限ループ" Style="{StaticResource SettingDescription}"/>
                            </StackPanel>
                            <ui:NumberBox Grid.Column="1" Value="{Binding LoopCount}" Minimum="0" 
                                          SpinButtonPlacementMode="Compact"/>
                        </Grid>
                    </Border>

                    <!-- コメント -->
                    <Border Style="{StaticResource SettingCard}">
                        <StackPanel>
                            <TextBlock Text="コメント" Style="{StaticResource SettingLabel}" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" 
                                     AcceptsReturn="True" TextWrapping="Wrap" MinHeight="60"/>
                        </StackPanel>
                    </Border>

                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!-- スプリッター -->
        <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" 
                      Background="Transparent" Cursor="SizeWE"/>

        <!-- プレビューエリア -->
        <Border Grid.Column="2" Background="{ui:ThemeResource ControlFillColorDefaultBrush}" 
                CornerRadius="8" Margin="4" Padding="12">
            <StackPanel>
                <TextBlock Text="プレビュー" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,12"
                           Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                
                <!-- 画像プレビュー -->
                <Border CornerRadius="4" Background="{ui:ThemeResource ControlFillColorSecondaryBrush}"
                        MinHeight="150" Margin="0,0,0,12">
                    <Border.Visibility>
                        <MultiBinding Converter="{StaticResource BoolToVisibilityMultiConverter}">
                            <Binding Path="IsWaitImageItem"/>
                            <Binding Path="IsClickImageItem"/>
                            <Binding Path="IsIfImageExistItem"/>
                            <Binding Path="IsIfImageNotExistItem"/>
                        </MultiBinding>
                    </Border.Visibility>
                    <Image Source="{Binding ImagePath}" Stretch="Uniform" MaxHeight="200"/>
                </Border>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
