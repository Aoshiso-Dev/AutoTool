<Window x:Class="AutoTool.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AutoTool"
        xmlns:view="clr-namespace:AutoTool.View"
        xmlns:panels="clr-namespace:AutoTool.View.Panels"
        xmlns:converters="clr-namespace:AutoTool.View.Converters"
        mc:Ignorable="d"
        Title="{Binding Title}" 
        MinWidth="800" MinHeight="600"
        Height="{Binding WindowHeight, Mode=TwoWay}" 
        Width="{Binding WindowWidth, Mode=TwoWay}"
        WindowState="{Binding WindowState, Mode=TwoWay}"
        Closing="Window_Closing"
        FontFamily="Segoe UI, Segoe UI Emoji, Segoe UI Symbol">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/AutoTool;component/Styles/ListPanelStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <!-- Local Converters -->
            <converters:InvertBooleanConverter x:Key="InvertBooleanConverter"/>
            <converters:RunningStatusConverter x:Key="RunningStatusConverter"/>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:MultiBoolToVisibilityConverter x:Key="MultiBoolToVisibilityConverter"/>
            <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
        </ResourceDictionary>
    </Window.Resources>

    <!-- Keyboard shortcuts -->
    <Window.InputBindings>
        <!-- File operations -->
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveFileCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveFileAsCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenFileCommand}"/>
        <!-- Undo/Redo operations -->
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}" />
        <KeyBinding Key="Y" Modifiers="Ctrl" Command="{Binding RedoCommand}" />
        <KeyBinding Key="Z" Modifiers="Ctrl+Shift" Command="{Binding RedoCommand}" />
    </Window.InputBindings>
    
    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}">
            <MenuItem Header="ファイル(_F)">
                <MenuItem Header="開く(_O)" Command="{Binding OpenFileCommand}" InputGestureText="Ctrl+O"/>
                <MenuItem Header="{Binding MenuItemHeader_SaveFile}" Command="{Binding SaveFileCommand}" InputGestureText="Ctrl+S"/>
                <MenuItem Header="{Binding MenuItemHeader_SaveFileAs}" Command="{Binding SaveFileAsCommand}" InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="最近開いたファイル" ItemsSource="{Binding RecentFiles}">
                    <MenuItem.ItemTemplate>
                        <DataTemplate>
                            <MenuItem Header="{Binding FileName}" Command="{Binding DataContext.OpenFileCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding FilePath}" />
                        </DataTemplate>
                    </MenuItem.ItemTemplate>
                </MenuItem>
                <Separator/>
                <MenuItem Header="設定" />
                <Separator/>
                <MenuItem Header="終了(_X)" Command="{Binding ExitCommand}" InputGestureText="Alt+F4"/>
            </MenuItem>
            <MenuItem Header="編集(_E)">
                <MenuItem Header="元に戻す(_U)" Command="{Binding UndoCommand}" InputGestureText="Ctrl+Z"/>
                <MenuItem Header="やり直し(_R)" Command="{Binding RedoCommand}" InputGestureText="Ctrl+Y"/>
                <Separator/>
                <MenuItem Header="切り取り(_T)" Command="ApplicationCommands.Cut" InputGestureText="Ctrl+X"/>
                <MenuItem Header="コピー(_C)" Command="ApplicationCommands.Copy" InputGestureText="Ctrl+C"/>
                <MenuItem Header="貼り付け(_P)" Command="ApplicationCommands.Paste" InputGestureText="Ctrl+V"/>
                <MenuItem Header="削除(_D)" Command="ApplicationCommands.Delete" InputGestureText="Delete"/>
            </MenuItem>
            <MenuItem Header="表示(_V)">
                <MenuItem Header="テーマ(_T)">
                    <MenuItem Header="ライト" Command="{Binding ChangeThemeCommand}" CommandParameter="Light" />
                    <MenuItem Header="ダーク" Command="{Binding ChangeThemeCommand}" CommandParameter="Dark" />
                    <MenuItem Header="システム設定に合わせる" Command="{Binding ChangeThemeCommand}" CommandParameter="Auto" />
                </MenuItem>
                <Separator/>
                <MenuItem Header="パフォーマンス情報を更新" Command="{Binding RefreshPerformanceCommand}" />
            </MenuItem>
            <MenuItem Header="プラグイン(_P)">
                <MenuItem Header="プラグインの読み込み..." Command="{Binding LoadPluginFileCommand}" />
                <MenuItem Header="全プラグインの再読み込み" Command="{Binding RefreshPluginsCommand}" />
                <Separator/>
                <MenuItem Header="プラグイン情報の表示" Command="{Binding ShowPluginInfoCommand}" />
            </MenuItem>
            <MenuItem Header="ツール(_T)">
                <MenuItem Header="アプリケーションフォルダを開く" Command="{Binding OpenAppDirCommand}" />
            </MenuItem>
            <MenuItem Header="ヘルプ(_H)">
                <MenuItem Header="バージョン情報(_A)..." Command="{Binding ShowAboutCommand}" />
            </MenuItem>
        </Menu>

        <!-- Toolbar with integrated button panel -->
        <ToolBarTray Grid.Row="1">
            <ToolBar>
                <!-- File operations - disabled during execution -->
                <Button Content="開く" Command="{Binding OpenFileCommand}" ToolTip="ファイルを開く (Ctrl+O)" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" />
                <Button Content="保存" Command="{Binding SaveFileCommand}" ToolTip="ファイルを保存 (Ctrl+S)" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" />
                <Separator />
                
                <!-- Undo/Redo - disabled during execution -->
                <Button Content="元に戻す" Command="{Binding UndoCommand}" ToolTip="元に戻す (Ctrl+Z)"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}"/>
                <Button Content="やり直し" Command="{Binding RedoCommand}" ToolTip="やり直し (Ctrl+Y)"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}"/>
                <Separator />
                
                <!-- Execution control - always enabled -->
                <Button Command="{Binding RunMacroCommand}" Width="100" Margin="2" Foreground="White">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Green"/>
                            <Setter Property="Content" Value="実行"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                    <Setter Property="Background" Value="Red"/>
                                    <Setter Property="Content" Value="停止"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <Separator />
                
                <!-- List operations - disabled during execution -->
                <ComboBox ItemsSource="{Binding ItemTypes}" 
                          SelectedItem="{Binding SelectedItemType}" 
                          DisplayMemberPath="DisplayName"
                          IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                          VerticalContentAlignment="Center" 
                          Width="150" 
                          Margin="2"/>
                <Button Content="追加" Command="{Binding AddCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2"/>
                <Button Content="削除" Command="{Binding DeleteCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2"/>
                <Button Content="↑" Command="{Binding UpCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="30" Margin="2" ToolTip="上に移動"/>
                <Button Content="↓" Command="{Binding DownCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="30" Margin="2" ToolTip="下に移動"/>
                <Button Content="クリア" Command="{Binding ClearCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2"/>
                <Separator />
                
                <!-- Debug test buttons - disabled during execution -->
                <Button Content="TEST" Command="{Binding AddTestCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2" 
                        Background="Orange" Foreground="White"
                        ToolTip="テストコマンド追加（デバッグ用）"/>
                <Button Content="実行テスト" Command="{Binding TestExecutionHighlightCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="70" Height="Auto" Margin="2" 
                        Background="Purple" Foreground="White"
                        ToolTip="実行ハイライトテスト（デバッグ用）"/>
                <Button Content="状態確認" Click="DebugStateButton_Click"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="70" Height="Auto" Margin="2" 
                        Background="Navy" Foreground="White"
                        ToolTip="実行状態確認（デバッグ用）"/>
            </ToolBar>
        </ToolBarTray>

        <!-- Main Content -->
        <Grid Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <!-- Loading Indicator -->
            <Border Background="#80000000" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="読み込み中..." Foreground="White" FontSize="20" HorizontalAlignment="Center" />
                    <ProgressBar IsIndeterminate="True" Width="200" Height="20" Margin="0,10,0,0" />
                </StackPanel>
            </Border>

            <!-- Main Panel (3-column layout) -->
            <Grid Visibility="{Binding IsLoading, Converter={StaticResource InvertBooleanConverter}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="350"/>
                    <ColumnDefinition Width="5"/>
                    <ColumnDefinition Width="450"/>
                </Grid.ColumnDefinitions>

                <!-- Left Panel: Enhanced Command List with Progress -->
                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="5"/>
                        <RowDefinition Height="150" MinHeight="100"/>
                    </Grid.RowDefinitions>

                    <!-- Command List Header -->
                    <Border Grid.Row="0" Background="LightGray" Padding="5">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="コマンドリスト" FontWeight="Bold" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding CommandCount, StringFormat=' ({0}個)'}" 
                                       FontSize="11" Foreground="#666" VerticalAlignment="Center" Margin="5,0,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Enhanced Command List with ListPanelView -->
                    <panels:ListPanelView Grid.Row="1" x:Name="CommandListPanel"/>

                    <!-- Splitter -->
                    <GridSplitter Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                                  Background="LightGray" ShowsPreview="True"/>

                    <!-- Log Panel -->
                    <Grid Grid.Row="3">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Log Header -->
                        <Border Grid.Row="0" Background="LightGray" Padding="5">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="実行ログ" FontWeight="Bold" VerticalAlignment="Center"/>
                                <Button Content="クリア" Command="{Binding ClearLogCommand}" 
                                        Width="50" Height="20" Margin="10,0,0,0" FontSize="10"/>
                            </StackPanel>
                        </Border>

                        <!-- Log List -->
                        <ListBox Grid.Row="1" 
                                 ItemsSource="{Binding LogEntries}"
                                 ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}" FontFamily="Consolas" FontSize="10" TextWrapping="Wrap"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Grid>

                <!-- Splitter 1 -->
                <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                              Background="LightGray" ShowsPreview="True"/>

                <!-- Center Panel: Edit -->
                <Grid Grid.Column="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Edit Header -->
                    <Border Grid.Row="0" Background="LightGray" Padding="5">
                        <TextBlock Text="コマンド設定" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </Border>

                    <!-- Edit Content - replaced with EditPanelView UserControl -->
                    <panels:EditPanelView Grid.Row="1" x:Name="EditPanelViewControl" />
                </Grid>
                 
                
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Height="25">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <Separator />
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="メモリ: " />
                    <TextBlock Text="{Binding MemoryUsage}" Margin="0,0,10,0" />
                    <TextBlock Text="CPU: " />
                    <TextBlock Text="{Binding CpuUsage}" Margin="0,0,10,0" />
                    <TextBlock Text="実行状態: " />
                    <TextBlock Text="{Binding IsRunning, Converter={StaticResource RunningStatusConverter}}" Margin="0,0,10,0" />
                    <TextBlock Text="プラグイン: " />
                    <TextBlock Text="{Binding PluginCount}" Margin="0,0,5,0" />
                    <TextBlock Text="個 / コマンド: " />
                    <TextBlock Text="{Binding CommandCount}" Margin="0,0,5,0" />
                    <TextBlock Text="個" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
