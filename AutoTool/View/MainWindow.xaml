<Window x:Class="AutoTool.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AutoTool"
        xmlns:view="clr-namespace:AutoTool.View"
        xmlns:panels="clr-namespace:AutoTool.View.Panels"
        xmlns:converters="clr-namespace:AutoTool.View.Converters"
        mc:Ignorable="d"
        Title="{Binding Title}" 
        MinWidth="800" MinHeight="600"
        Height="{Binding WindowHeight, Mode=TwoWay}" 
        Width="{Binding WindowWidth, Mode=TwoWay}"
        WindowState="{Binding WindowState, Mode=TwoWay}"
        Closing="Window_Closing">

    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/AutoTool;component/Styles/ListPanelStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <!-- Local Converters -->
            <converters:InvertBooleanConverter x:Key="InvertBooleanConverter"/>
            <converters:RunningStatusConverter x:Key="RunningStatusConverter"/>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:MultiBoolToVisibilityConverter x:Key="MultiBoolToVisibilityConverter"/>
            <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
        </ResourceDictionary>
    </Window.Resources>

    <!-- Keyboard shortcuts -->
    <Window.InputBindings>
        <!-- File operations -->
        <KeyBinding Key="S" Modifiers="Ctrl" Command="{Binding SaveFileCommand}"/>
        <KeyBinding Key="S" Modifiers="Ctrl+Shift" Command="{Binding SaveFileAsCommand}"/>
        <KeyBinding Key="O" Modifiers="Ctrl" Command="{Binding OpenFileCommand}"/>
        <!-- Undo/Redo operations -->
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}" />
        <KeyBinding Key="Y" Modifiers="Ctrl" Command="{Binding RedoCommand}" />
        <KeyBinding Key="Z" Modifiers="Ctrl+Shift" Command="{Binding RedoCommand}" />
    </Window.InputBindings>
    
    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <Menu Grid.Row="0" IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}">
            <MenuItem Header="ファイル(_F)">
                <MenuItem Header="開く(_O)" Command="{Binding OpenFileCommand}" InputGestureText="Ctrl+O"/>
                <MenuItem Header="{Binding MenuItemHeader_SaveFile}" Command="{Binding SaveFileCommand}" InputGestureText="Ctrl+S"/>
                <MenuItem Header="{Binding MenuItemHeader_SaveFileAs}" Command="{Binding SaveFileAsCommand}" InputGestureText="Ctrl+Shift+S"/>
                <Separator/>
                <MenuItem Header="最近開いたファイル" ItemsSource="{Binding RecentFiles}">
                    <MenuItem.ItemTemplate>
                        <DataTemplate>
                            <MenuItem Header="{Binding FileName}" Command="{Binding DataContext.OpenFileCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding FilePath}" />
                        </DataTemplate>
                    </MenuItem.ItemTemplate>
                </MenuItem>
                <Separator/>
                <MenuItem Header="設定" />
                <Separator/>
                <MenuItem Header="終了(_X)" Command="{Binding ExitCommand}" InputGestureText="Alt+F4"/>
            </MenuItem>
            <MenuItem Header="編集(_E)">
                <MenuItem Header="元に戻す(_U)" Command="{Binding UndoCommand}" InputGestureText="Ctrl+Z"/>
                <MenuItem Header="やり直し(_R)" Command="{Binding RedoCommand}" InputGestureText="Ctrl+Y"/>
                <Separator/>
                <MenuItem Header="切り取り(_T)" Command="ApplicationCommands.Cut" InputGestureText="Ctrl+X"/>
                <MenuItem Header="コピー(_C)" Command="ApplicationCommands.Copy" InputGestureText="Ctrl+C"/>
                <MenuItem Header="貼り付け(_P)" Command="ApplicationCommands.Paste" InputGestureText="Ctrl+V"/>
                <MenuItem Header="削除(_D)" Command="ApplicationCommands.Delete" InputGestureText="Delete"/>
            </MenuItem>
            <MenuItem Header="表示(_V)">
                <MenuItem Header="テーマ(_T)">
                    <MenuItem Header="ライト" Command="{Binding ChangeThemeCommand}" CommandParameter="Light" />
                    <MenuItem Header="ダーク" Command="{Binding ChangeThemeCommand}" CommandParameter="Dark" />
                    <MenuItem Header="システム設定に合わせる" Command="{Binding ChangeThemeCommand}" CommandParameter="Auto" />
                </MenuItem>
                <Separator/>
                <MenuItem Header="パフォーマンス情報を更新" Command="{Binding RefreshPerformanceCommand}" />
            </MenuItem>
            <MenuItem Header="プラグイン(_P)">
                <MenuItem Header="プラグインの読み込み..." Command="{Binding LoadPluginFileCommand}" />
                <MenuItem Header="全プラグインの再読み込み" Command="{Binding RefreshPluginsCommand}" />
                <Separator/>
                <MenuItem Header="プラグイン情報の表示" Command="{Binding ShowPluginInfoCommand}" />
            </MenuItem>
            <MenuItem Header="ツール(_T)">
                <MenuItem Header="アプリケーションフォルダを開く" Command="{Binding OpenAppDirCommand}" />
            </MenuItem>
            <MenuItem Header="ヘルプ(_H)">
                <MenuItem Header="バージョン情報(_A)..." Command="{Binding ShowAboutCommand}" />
            </MenuItem>
        </Menu>

        <!-- Toolbar with integrated button panel -->
        <ToolBarTray Grid.Row="1">
            <ToolBar IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}">
                <!-- File operations -->
                <Button Content="開く" Command="{Binding OpenFileCommand}" ToolTip="ファイルを開く (Ctrl+O)" />
                <Button Content="保存" Command="{Binding SaveFileCommand}" ToolTip="ファイルを保存 (Ctrl+S)" />
                <Separator />
                
                <!-- Undo/Redo -->
                <Button Content="元に戻す" Command="{Binding UndoCommand}" ToolTip="元に戻す (Ctrl+Z)"/>
                <Button Content="やり直し" Command="{Binding RedoCommand}" ToolTip="やり直し (Ctrl+Y)"/>
                <Separator />
                
                <!-- Execution control -->
                <Button Command="{Binding RunMacroCommand}" Width="100" Margin="2" Foreground="White">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Green"/>
                            <Setter Property="Content" Value="実行"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                    <Setter Property="Background" Value="Red"/>
                                    <Setter Property="Content" Value="停止"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
                <Separator />
                
                <!-- List operations -->
                <ComboBox ItemsSource="{Binding ItemTypes}" 
                          SelectedItem="{Binding SelectedItemType}" 
                          DisplayMemberPath="DisplayName"
                          IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                          VerticalContentAlignment="Center" 
                          Width="150" 
                          Margin="2"/>
                <Button Content="追加" Command="{Binding AddCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2"/>
                <Button Content="削除" Command="{Binding DeleteCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2"/>
                <Button Content="↑" Command="{Binding UpCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="30" Margin="2" ToolTip="上に移動"/>
                <Button Content="↓" Command="{Binding DownCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="30" Margin="2" ToolTip="下に移動"/>
                <Button Content="クリア" Command="{Binding ClearCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2"/>
                <Separator />
                
                <!-- Debug test buttons -->
                <Button Content="TEST" Command="{Binding AddTestCommandCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="50" Height="Auto" Margin="2" 
                        Background="Orange" Foreground="White"
                        ToolTip="テストコマンド追加（デバッグ用）"/>
                <Button Content="実行テスト" Command="{Binding TestExecutionHighlightCommand}" 
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="70" Height="Auto" Margin="2" 
                        Background="Purple" Foreground="White"
                        ToolTip="実行ハイライトテスト（デバッグ用）"/>
                <Button Content="状態確認" Click="DebugStateButton_Click"
                        IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" 
                        Width="70" Height="Auto" Margin="2" 
                        Background="Navy" Foreground="White"
                        ToolTip="実行状態確認（デバッグ用）"/>
            </ToolBar>
        </ToolBarTray>

        <!-- Main Content -->
        <Grid Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <!-- Loading Indicator -->
            <Border Background="#80000000" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="読み込み中..." Foreground="White" FontSize="20" HorizontalAlignment="Center" />
                    <ProgressBar IsIndeterminate="True" Width="200" Height="20" Margin="0,10,0,0" />
                </StackPanel>
            </Border>

            <!-- Main Panel (3-column layout) -->
            <Grid Visibility="{Binding IsLoading, Converter={StaticResource InvertBooleanConverter}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" MinWidth="350"/>
                    <ColumnDefinition Width="5"/>
                    <ColumnDefinition Width="300" MinWidth="250"/>
                    <ColumnDefinition Width="5"/>
                    <ColumnDefinition Width="250" MinWidth="200"/>
                </Grid.ColumnDefinitions>

                <!-- Left Panel: Enhanced Command List with Progress -->
                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="5"/>
                        <RowDefinition Height="150" MinHeight="100"/>
                    </Grid.RowDefinitions>

                    <!-- Command List Header -->
                    <Border Grid.Row="0" Background="LightGray" Padding="5">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📋 コマンドリスト" FontWeight="Bold" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding CommandCount, StringFormat=' ({0}個)'}" 
                                       FontSize="11" Foreground="#666" VerticalAlignment="Center" Margin="5,0,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Enhanced Command List with ListPanelView -->
                    <panels:ListPanelView Grid.Row="1" x:Name="CommandListPanel"/>

                    <!-- Splitter -->
                    <GridSplitter Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                                  Background="LightGray" ShowsPreview="True"/>

                    <!-- Log Panel -->
                    <Grid Grid.Row="3">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Log Header -->
                        <Border Grid.Row="0" Background="LightGray" Padding="5">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="📝 実行ログ" FontWeight="Bold" VerticalAlignment="Center"/>
                                <Button Content="クリア" Command="{Binding ClearLogCommand}" 
                                        Width="50" Height="20" Margin="10,0,0,0" FontSize="10"/>
                            </StackPanel>
                        </Border>

                        <!-- Log List -->
                        <ListBox Grid.Row="1" 
                                 ItemsSource="{Binding LogEntries}"
                                 ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}" FontFamily="Consolas" FontSize="10" TextWrapping="Wrap"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Grid>

                <!-- Splitter 1 -->
                <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                              Background="LightGray" ShowsPreview="True"/>

                <!-- Center Panel: Edit -->
                <Grid Grid.Column="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Edit Header -->
                    <Border Grid.Row="0" Background="LightGray" Padding="5">
                        <TextBlock Text="⚙️ コマンド設定" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </Border>

                    <!-- Edit Content - Enhanced Settings Panel -->
                    <Grid Grid.Row="1" IsEnabled="{Binding IsRunning, Converter={StaticResource InvertBooleanConverter}}" Background="White">
                        <Border BorderBrush="LightGray" BorderThickness="1" Margin="5">
                            <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" 
                                          Margin="10" Padding="5" Background="White">
                                <StackPanel Background="White">
                                    <!-- No items message -->
                                    <StackPanel Visibility="{Binding IsListEmpty, Converter={StaticResource BoolToVisibilityConverter}}" 
                                                Margin="0,20">
                                        <TextBlock Text="📝 リストにコマンドを追加してください" 
                                                   FontSize="14" Foreground="DarkGray" TextWrapping="Wrap"/>
                                        <TextBlock Text="上部の「追加」ボタンでコマンドを追加できます" 
                                                   FontSize="11" Foreground="DarkGray" Margin="0,5,0,0" TextWrapping="Wrap"/>
                                    </StackPanel>

                                    <StackPanel Visibility="{Binding IsListNotEmptyButNoSelection, Converter={StaticResource BoolToVisibilityConverter}}" 
                                                Margin="0,20">
                                        <TextBlock Text="👆 リストからコマンドを選択してください" 
                                                   FontSize="14" Foreground="DarkGray" TextWrapping="Wrap"/>
                                        <TextBlock Text="選択すると設定項目が表示されます" 
                                                   FontSize="11" Foreground="DarkGray" Margin="0,5,0,0" TextWrapping="Wrap"/>
                                    </StackPanel>

                                    <!-- Settings (shown when item is selected) -->
                                    <StackPanel Visibility="{Binding IsNotNullItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <!-- Command Type Selection -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5">
                                            <TextBlock Text="コマンド:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <ComboBox ItemsSource="{Binding ItemTypes}" 
                                                      SelectedItem="{Binding SelectedItemTypeObj}" 
                                                      DisplayMemberPath="DisplayName"
                                                      Width="200" Margin="5,0"
                                                      Foreground="Black" Background="White"/>
                                        </StackPanel>

                                        <!-- Window Target Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding ShowWindowInfo, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="対象ウィンドウ:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding WindowTitle, UpdateSourceTrigger=PropertyChanged}" Width="200" 
                                                         Foreground="Black" Background="White"/>
                                                <Button Content="取得" Command="{Binding GetWindowInfoCommand}" Margin="5,0,2,0" Width="40"
                                                        Foreground="Black" Background="#F0F0F0"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="ウィンドウクラス:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding WindowClassName, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                                         Foreground="Black" Background="White"/>
                                                <Button Content="クリア" Command="{Binding ClearWindowInfoCommand}" Margin="5,0,2,0" Width="40"
                                                        Foreground="Black" Background="#F0F0F0"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Image Path Settings -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5" 
                                                    Visibility="{Binding IsImageBasedItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="画像パス:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <TextBox Text="{Binding ImagePath, UpdateSourceTrigger=PropertyChanged}" IsReadOnly="True" Width="150"
                                                     Foreground="Black" Background="White"/>
                                            <Button Content="参照" Command="{Binding BrowseImageFileCommand}" Margin="5,0,2,0" Width="40"
                                                    Foreground="Black" Background="#F0F0F0"/>
                                        </StackPanel>

                                        <!-- Threshold Settings -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5"
                                                    Visibility="{Binding IsImageBasedItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="しきい値:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <Slider Value="{Binding Threshold, UpdateSourceTrigger=PropertyChanged}" 
                                                    Minimum="0.01" Maximum="1.00" SmallChange="0.01" LargeChange="0.1" 
                                                    TickFrequency="0.01" IsSnapToTickEnabled="True" Width="120"/>
                                            <TextBox Text="{Binding Threshold, StringFormat=F2}" IsReadOnly="True" Width="50" Margin="5,0"
                                                     Foreground="Black" Background="White"/>
                                        </StackPanel>

                                        <!-- AI Model Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding IsAIBasedItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="ONNXモデル:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding ModelPath, UpdateSourceTrigger=PropertyChanged}" IsReadOnly="True" Width="150"
                                                         Foreground="Black" Background="White"/>
                                                <Button Content="参照" Command="{Binding BrowseModelFileCommand}" Margin="5,0" Width="40"
                                                        Foreground="Black" Background="#F0F0F0"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="クラスID:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding ClassID, UpdateSourceTrigger=PropertyChanged}" Width="100"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="信頼度閾値:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <Slider Value="{Binding ConfThreshold, UpdateSourceTrigger=PropertyChanged}" 
                                                        Minimum="0.01" Maximum="1.00" SmallChange="0.01" LargeChange="0.1" 
                                                        TickFrequency="0.01" IsSnapToTickEnabled="True" Width="100"/>
                                                <TextBox Text="{Binding ConfThreshold, StringFormat=F2}" IsReadOnly="True" Width="50" Margin="5,0"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="IoU閾値:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <Slider Value="{Binding IoUThreshold, UpdateSourceTrigger=PropertyChanged}" 
                                                        Minimum="0.01" Maximum="1.00" SmallChange="0.01" LargeChange="0.1" 
                                                        TickFrequency="0.01" IsSnapToTickEnabled="True" Width="100"/>
                                                <TextBox Text="{Binding IoUThreshold, StringFormat=F2}" IsReadOnly="True" Width="50" Margin="5,0"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Click Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding IsClickItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="X座標:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding ClickX, UpdateSourceTrigger=PropertyChanged}" Width="80"
                                                         Foreground="Black" Background="White"/>
                                                <Button Content="取得" Command="{Binding GetMousePositionCommand}" Margin="5,0" Width="40"
                                                        Foreground="Black" Background="#F0F0F0"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="Y座標:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding ClickY, UpdateSourceTrigger=PropertyChanged}" Width="80"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Mouse Button Settings -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5">
                                            <TextBlock Text="ボタン:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <ComboBox ItemsSource="{Binding MouseButtons}" 
                                                      SelectedItem="{Binding MouseButton}" Width="120"
                                                      Foreground="Black" Background="White"/>
                                            <StackPanel.Visibility>
                                                <MultiBinding Converter="{StaticResource MultiBoolToVisibilityConverter}">
                                                    <Binding Path="IsClickImageItem"/>
                                                    <Binding Path="IsClickImageAIItem"/>
                                                    <Binding Path="IsClickItem"/>
                                                </MultiBinding>
                                            </StackPanel.Visibility>
                                        </StackPanel>

                                        <!-- Background Click Settings -->
                                        <StackPanel Margin="0,5">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="バックグラウンドクリック:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <CheckBox IsChecked="{Binding UseBackgroundClick, UpdateSourceTrigger=PropertyChanged}" 
                                                          Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="バックグラウンド方式:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <ComboBox ItemsSource="{Binding BackgroundClickMethods}" 
                                                          SelectedValue="{Binding BackgroundClickMethod}" 
                                                          SelectedValuePath="Value"
                                                          DisplayMemberPath="DisplayName"
                                                          Width="200" Margin="5,0"
                                                          Foreground="Black" Background="White"
                                                          IsEnabled="{Binding UseBackgroundClick}"/>
                                            </StackPanel>
                                            <StackPanel.Visibility>
                                                <MultiBinding Converter="{StaticResource MultiBoolToVisibilityConverter}">
                                                    <Binding Path="IsClickImageItem"/>
                                                    <Binding Path="IsClickImageAIItem"/>
                                                    <Binding Path="IsClickItem"/>
                                                </MultiBinding>
                                            </StackPanel.Visibility>
                                        </StackPanel>

                                        <!-- Hotkey Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding IsHotkeyItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="Ctrl:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <CheckBox IsChecked="{Binding CtrlKey, UpdateSourceTrigger=PropertyChanged}" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="Shift:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <CheckBox IsChecked="{Binding ShiftKey, UpdateSourceTrigger=PropertyChanged}" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="Alt:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <CheckBox IsChecked="{Binding AltKey, UpdateSourceTrigger=PropertyChanged}" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="キー:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <ComboBox ItemsSource="{Binding KeyList}" 
                                                          SelectedItem="{Binding SelectedKey}" Width="120"
                                                          Foreground="Black" Background="White"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Wait Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding IsWaitItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="待機時間:" Width="120" Foreground="Black"/>
                                                <TextBox Text="{Binding WaitHours, UpdateSourceTrigger=PropertyChanged}" 
                                                         Width="30" VerticalAlignment="Center"
                                                         Foreground="Black" Background="White"/>
                                                <TextBlock Text="時間" Margin="5,0" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding WaitMinutes, UpdateSourceTrigger=PropertyChanged}" 
                                                         Width="30" VerticalAlignment="Center"
                                                         Foreground="Black" Background="White"/>
                                                <TextBlock Text="分" Margin="5,0" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding WaitSeconds, UpdateSourceTrigger=PropertyChanged}" 
                                                         Width="30" VerticalAlignment="Center"
                                                         Foreground="Black" Background="White"/>
                                                <TextBlock Text="秒" Margin="5,0" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding WaitMilliseconds, UpdateSourceTrigger=PropertyChanged}" 
                                                         Width="50" VerticalAlignment="Center"
                                                         Foreground="Black" Background="White"/>
                                                <TextBlock Text="ms" Margin="5,0" VerticalAlignment="Center" Foreground="Black"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Loop Settings -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5" 
                                                    Visibility="{Binding IsLoopItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="ループ回数:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <TextBox Text="{Binding LoopCount, UpdateSourceTrigger=PropertyChanged}" Width="100"
                                                     Foreground="Black" Background="White"/>
                                        </StackPanel>

                                        <!-- Variable Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding IsVariableItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="変数名:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding VariableName, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2" 
                                                        Visibility="{Binding IsSetVariableItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                                <TextBlock Text="変数値:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding VariableValue, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                            <StackPanel Visibility="{Binding IsIfVariableItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                                    <TextBlock Text="演算子:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                    <ComboBox ItemsSource="{Binding Operators}" 
                                                              SelectedValue="{Binding VariableOperator}" 
                                                              SelectedValuePath="Key"
                                                              DisplayMemberPath="DisplayName"
                                                              Width="120" Foreground="Black" Background="White"/>
                                                </StackPanel>
                                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                                    <TextBlock Text="比較値:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                    <TextBox Text="{Binding VariableValue, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                                             Foreground="Black" Background="White"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Execute Program Settings -->
                                        <StackPanel Margin="0,5" Visibility="{Binding IsExecuteItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="プログラムパス:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding ProgramPath, UpdateSourceTrigger=PropertyChanged}" IsReadOnly="True" Width="150"
                                                         Foreground="Black" Background="White"/>
                                                <Button Content="参照" Command="{Binding BrowseProgramFileCommand}" Margin="5,0" Width="40"
                                                        Foreground="Black" Background="#F0F0F0"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="引数:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding Arguments, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                                         Foreground="Black" Background="White"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="作業フォルダ:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding WorkingDirectory, UpdateSourceTrigger=PropertyChanged}" IsReadOnly="True" Width="150"
                                                         Foreground="Black" Background="White"/>
                                                <Button Content="参照" Command="{Binding BrowseWorkingDirectoryCommand}" Margin="5,0" Width="40"
                                                        Foreground="Black" Background="#F0F0F0"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="終了まで待機:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <CheckBox IsChecked="{Binding WaitForExit, UpdateSourceTrigger=PropertyChanged}" Foreground="Black"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Screenshot Settings -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5" 
                                                    Visibility="{Binding IsScreenshotItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="保存先フォルダ:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <TextBox Text="{Binding SaveDirectory, UpdateSourceTrigger=PropertyChanged}" IsReadOnly="True" Width="150"
                                                     Foreground="Black" Background="White"/>
                                            <Button Content="参照" Command="{Binding BrowseSaveDirectoryCommand}" Margin="5,0" Width="40"
                                                    Foreground="Black" Background="#F0F0F0"/>
                                        </StackPanel>

                                        <!-- Timeout and Interval Settings -->
                                        <StackPanel Margin="0,5">
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="タイムアウト:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding Timeout, UpdateSourceTrigger=PropertyChanged}" Width="80"
                                                         Foreground="Black" Background="White"/>
                                                <TextBlock Text="ms" Margin="5,0" VerticalAlignment="Center" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <TextBlock Text="実行間隔:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                                <TextBox Text="{Binding Interval, UpdateSourceTrigger=PropertyChanged}" Width="80"
                                                         Foreground="Black" Background="White"/>
                                                <TextBlock Text="ms" Margin="5,0" VerticalAlignment="Center" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel.Visibility>
                                                <MultiBinding Converter="{StaticResource MultiBoolToVisibilityConverter}">
                                                    <Binding Path="IsWaitImageItem"/>
                                                    <Binding Path="IsClickImageItem"/>
                                                </MultiBinding>
                                            </StackPanel.Visibility>
                                        </StackPanel>

                                        <!-- AI Detect Mode Settings -->
                                        <StackPanel Orientation="Horizontal" Margin="0,5" 
                                                    Visibility="{Binding IsSetVariableAIItem, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="AI検出モード:" Width="120" VerticalAlignment="Center" Foreground="Black"/>
                                            <ComboBox ItemsSource="{Binding AiDetectModes}" 
                                                      SelectedValue="{Binding AiDetectMode}" 
                                                      SelectedValuePath="Key"
                                                      DisplayMemberPath="DisplayName"
                                                      Width="120" Foreground="Black" Background="White"/>
                                        </StackPanel>

                                        <!-- Comment Settings (for all commands) -->
                                        <StackPanel Margin="0,10" Visibility="{Binding ShowAdvancedSettings, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="コメント:" Margin="0,0,0,5" Foreground="Black"/>
                                            <TextBox Text="{Binding Comment, UpdateSourceTrigger=PropertyChanged}" 
                                                     Height="60" TextWrapping="Wrap" AcceptsReturn="True"
                                                     VerticalScrollBarVisibility="Auto"
                                                     Foreground="Black" Background="White"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </Grid>

                <!-- Splitter 2 -->
                <GridSplitter Grid.Column="3" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" 
                              Background="LightGray" ShowsPreview="True"/>

                <!-- Right Panel: Favorites & Settings -->
                <Grid Grid.Column="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Favorites Header -->
                    <Border Grid.Row="0" Background="LightGray" Padding="5">
                        <TextBlock Text="⭐ お気に入り" FontWeight="Bold" HorizontalAlignment="Center"/>
                    </Border>

                    <!-- Favorites Content -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" 
                                  Margin="10" Padding="5">
                        <StackPanel>
                            <!-- Favorites feature description -->
                            <Border BorderBrush="LightGreen" BorderThickness="1" Padding="10" Margin="0,10">
                                <StackPanel>
                                    <TextBlock Text="⭐ お気に入り機能" FontWeight="Bold" Foreground="DarkGreen"/>
                                    <TextBlock Text="よく使用するマクロやコマンドパターンを保存して、すぐに呼び出せる機能です。" 
                                               FontSize="11" Foreground="DarkGreen" TextWrapping="Wrap" Margin="0,5"/>
                                    <TextBlock Text="今後のバージョンで実装予定です。" 
                                               FontSize="11" Foreground="DarkGreen" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Border>

                            <!-- Settings feature description -->
                            <Border BorderBrush="LightCoral" BorderThickness="1" Padding="10" Margin="0,10">
                                <StackPanel>
                                    <TextBlock Text="⚙️ 設定機能" FontWeight="Bold" Foreground="DarkRed"/>
                                    <TextBlock Text="アプリケーションの動作設定、テーマ変更、ショートカットキーの設定などを行えます。" 
                                               FontSize="11" Foreground="DarkRed" TextWrapping="Wrap" Margin="0,5"/>
                                    <TextBlock Text="今後のバージョンで実装予定です。" 
                                               FontSize="11" Foreground="DarkRed" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Border>

                            <!-- Progress info panel -->
                            <Border BorderBrush="LightBlue" BorderThickness="1" Padding="10" Margin="0,10">
                                <StackPanel>
                                    <TextBlock Text="📊 実行進捗情報" FontWeight="Bold" Foreground="DarkBlue"/>
                                    <TextBlock Text="{Binding ProgressText}" 
                                               FontSize="12" Foreground="DarkBlue" Margin="0,5"/>
                                    <TextBlock Text="{Binding CurrentExecutingDescription}" 
                                               FontSize="11" Foreground="DarkBlue" TextWrapping="Wrap" Margin="0,2"/>
                                    <TextBlock Text="{Binding EstimatedTimeRemaining, StringFormat='残り時間: {0}'}" 
                                               FontSize="10" Foreground="DarkBlue" Margin="0,2"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Height="25">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" />
            </StatusBarItem>
            <Separator />
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="メモリ: " />
                    <TextBlock Text="{Binding MemoryUsage}" Margin="0,0,10,0" />
                    <TextBlock Text="CPU: " />
                    <TextBlock Text="{Binding CpuUsage}" Margin="0,0,10,0" />
                    <TextBlock Text="実行状態: " />
                    <TextBlock Text="{Binding IsRunning, Converter={StaticResource RunningStatusConverter}}" Margin="0,0,10,0" />
                    <TextBlock Text="プラグイン: " />
                    <TextBlock Text="{Binding PluginCount}" Margin="0,0,5,0" />
                    <TextBlock Text="個 / コマンド: " />
                    <TextBlock Text="{Binding CommandCount}" Margin="0,0,5,0" />
                    <TextBlock Text="個" />
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
